{% extends "base.html" %}
{% block title %}Etkinlik D√ºzenle: {{ event.name }}{% endblock %}

{% block extra_css %}
<style>
    .setup-wizard {
        display: none;
    }

    .setup-wizard.active {
        display: block;
    }

    #seating-canvas {
        position: relative;
        margin: 0 auto;
        cursor: crosshair;
        border-radius: 1rem;
        border: 2px dashed hsl(var(--border));
        background: hsl(var(--card));
        box-shadow: inset 0 1px 6px rgba(15, 23, 42, 0.08);
    }

    #seating-canvas.grid-enabled {
        background-image:
            repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(148, 163, 184, 0.15) 49px, rgba(148, 163, 184, 0.25) 50px),
            repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(148, 163, 184, 0.15) 49px, rgba(148, 163, 184, 0.25) 50px);
        background-size: 50px 50px;
    }

    .seat {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        color: #fff;
        font-weight: 600;
        font-size: 12px;
        user-select: none;
        border: 2px solid rgba(15, 23, 42, 0.15);
        box-shadow: 0 6px 12px rgba(15, 23, 42, 0.15);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .seat.table {
        border-radius: 0.75rem;
    }

    .seat.chair {
        border-radius: 999px;
        width: 35px;
        height: 35px;
    }

    .seat.selected {
        border: 3px solid hsl(var(--primary));
        box-shadow: 0 0 0 4px hsl(var(--primary) / 0.15);
        transform: scale(1.05);
    }

    .stage {
        position: absolute;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-weight: 700;
        cursor: move;
        border: 3px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 12px 25px rgba(15, 23, 42, 0.35);
        font-size: 18px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        border-radius: 0.75rem;
    }

    .stage.placing {
        opacity: 0.75;
        cursor: crosshair;
    }

    .resize-handle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: hsl(var(--primary));
        border: 2px solid #fff;
        border-radius: 999px;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
    }

    .resize-handle.se {
        bottom: -6px;
        right: -6px;
        cursor: se-resize;
    }

    .step-indicator {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .step {
        position: relative;
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        background: hsl(var(--muted));
        color: hsl(var(--muted-foreground));
        border: 1px solid hsl(var(--border));
        transition: all 0.2s ease;
    }

    .step strong {
        display: block;
        font-size: 0.95rem;
        margin-bottom: 0.4rem;
        color: hsl(var(--foreground));
    }

    .step.active {
        background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%);
        color: hsl(var(--primary-foreground));
        border-color: transparent;
        box-shadow: 0 12px 30px rgba(255, 107, 53, 0.28);
    }

    .step.completed {
        background: rgba(34, 197, 94, 0.12);
        color: rgb(21, 128, 61);
        border-color: rgba(34, 197, 94, 0.3);
        box-shadow: 0 10px 25px rgba(21, 128, 61, 0.18);
    }

    .step::after {
        content: '';
        position: absolute;
        inset-inline-end: 15px;
        inset-block-end: 12px;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 999px;
        z-index: 0;
    }

    .step.active::after {
        background: rgba(255, 255, 255, 0.2);
    }

    .step.completed::after {
        background: rgba(34, 197, 94, 0.2);
    }

    .step:last-child::after {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-1">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-600">Etkinlik d√ºzenleme</p>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{{ event.name|safe_text }}</h1>
            <p class="text-sm text-slate-600 dark:text-slate-400">Sahne, alan ve oturma d√ºzenini s√ºr√ºkle-bƒ±rak ile
                olu≈ütur.</p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <a href="{{ url_for('event.index') }}" class="btn-shadcn btn-shadcn-ghost btn-shadcn-sm">
                <i class="fas fa-arrow-left"></i>
                <span>Etkinlik listesi</span>
            </a>
            <a href="{{ url_for('reservation.index') }}" class="btn-shadcn btn-shadcn-outline btn-shadcn-sm">
                <i class="fas fa-ticket-alt"></i>
                <span>Rezervasyonlar</span>
            </a>
        </div>
    </div>

    <div class="card-shadcn">
        <div class="card-shadcn-content">
            <div class="step-indicator">
                <div class="step active" id="step-1-indicator">
                    <strong>1. Sahne Yerle≈üimi</strong>
                    <span class="text-sm">Sahnenin boyut ve konumunu belirle</span>
                </div>
                <div class="step" id="step-2-indicator">
                    <strong>2. Alan Yapƒ±landƒ±rmasƒ±</strong>
                    <span class="text-sm">Izgara yapƒ±sƒ± ve masa sayƒ±sƒ±nƒ± ayarla</span>
                </div>
                <div class="step" id="step-3-indicator">
                    <strong>3. Koltuk Yerle≈üimi</strong>
                    <span class="text-sm">Koltuk ve masalarƒ± yerle≈ütir</span>
                </div>
            </div>
        </div>
    </div>

    <div class="setup-wizard active" id="step-1">
        <div class="card-shadcn">
            <div class="card-shadcn-header pb-4">
                <div class="flex items-center gap-3">
                    <span
                        class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-primary/10 text-primary">
                        <i class="fas fa-theater-masks"></i>
                    </span>
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Adƒ±m 1: Sahne Yerle≈üimi</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Boyutlarƒ± belirle ve sahneyi kanvasa
                            yerle≈ütir.</p>
                    </div>
                </div>
            </div>
            <div class="card-shadcn-content space-y-4">
                <div class="grid gap-4 md:grid-cols-3">
                    <label class="space-y-2">
                        <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Sahne
                            Geni≈üliƒüi (px)</span>
                        <input type="number" id="stage-width" class="input-shadcn" value="200" min="100" max="600">
                    </label>
                    <label class="space-y-2">
                        <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Sahne
                            Y√ºksekliƒüi (px)</span>
                        <input type="number" id="stage-height" class="input-shadcn" value="80" min="50" max="200">
                    </label>
                    <div class="flex flex-wrap items-center gap-3">
                        <button class="btn-shadcn btn-shadcn-default" id="place-stage-btn">
                            <i class="fas fa-plus"></i>
                            <span>Sahneyi Yerle≈ütir</span>
                        </button>
                        <button class="btn-shadcn btn-shadcn-outline" id="confirm-stage-btn" style="display:none;">
                            <i class="fas fa-check"></i>
                            <span>Onayla ve Devam Et</span>
                        </button>
                    </div>
                </div>
                <p
                    class="rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-800 dark:bg-slate-900/50 dark:text-slate-300">
                    Sahneyi yerle≈ütirmek i√ßin kanvas √ºzerinde istediƒüin noktayƒ± tƒ±kla. Onayladƒ±ktan sonra alan
                    yapƒ±landƒ±rmasƒ±na ge√ßebilirsin.
                </p>
            </div>
        </div>
    </div>

    <div class="setup-wizard" id="step-2">
        <div class="card-shadcn">
            <div class="card-shadcn-header pb-4">
                <div class="flex items-center gap-3">
                    <span
                        class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500/10 text-blue-500">
                        <i class="fas fa-table"></i>
                    </span>
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Adƒ±m 2: Alan Yapƒ±landƒ±rmasƒ±
                        </h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Masa sayƒ±sƒ±nƒ± ve ƒ±zgara yoƒüunluƒüunu
                            belirle.</p>
                    </div>
                </div>
            </div>
            <div class="card-shadcn-content space-y-4">
                <div class="grid gap-4 md:grid-cols-3">
                    <label class="space-y-2">
                        <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Toplam Masa
                            Sayƒ±sƒ±</span>
                        <input type="number" id="total-tables" class="input-shadcn" value="20" min="1" max="100">
                    </label>
                    <label class="space-y-2">
                        <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Izgara
                            Aralƒ±ƒüƒ± (px)</span>
                        <input type="number" id="grid-size" class="input-shadcn" value="50" min="25" max="100">
                    </label>
                    <label
                        class="flex items-center gap-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-600 dark:border-slate-800 dark:bg-slate-900/60 dark:text-slate-300">
                        <input class="h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary" type="checkbox"
                            id="show-grid" checked>
                        <span>Kƒ±lavuz √ßizgilerini g√∂ster</span>
                    </label>
                </div>

                <div class="flex flex-wrap gap-3">
                    <button class="btn-shadcn btn-shadcn-default" id="configure-grid-btn">
                        <i class="fas fa-cog"></i>
                        <span>Alanƒ± Olu≈ütur</span>
                    </button>
                    <button class="btn-shadcn btn-shadcn-default" id="confirm-grid-btn" style="display:none;">
                        <i class="fas fa-check"></i>
                        <span>Devam Et</span>
                    </button>
                    <button class="btn-shadcn btn-shadcn-ghost" id="back-to-stage-btn">
                        <i class="fas fa-arrow-left"></i>
                        <span>√ñnceki Adƒ±m</span>
                    </button>
                </div>

                <div id="grid-info"
                    class="hidden rounded-xl border border-blue-200 bg-blue-50 p-4 text-sm text-blue-700 dark:border-blue-900 dark:bg-blue-950/40 dark:text-blue-200">
                    <strong class="block text-blue-800 dark:text-blue-100">Alan Bilgisi</strong>
                    <div id="canvas-dimensions" class="mt-2 leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="setup-wizard" id="step-3">
        <div class="card-shadcn">
            <div class="card-shadcn-header pb-4">
                <div class="flex items-center gap-3">
                    <span
                        class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500/10 text-emerald-500">
                        <i class="fas fa-chair"></i>
                    </span>
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Adƒ±m 3: Koltuk Yerle≈üimi</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Koltuk tiplerini se√ß ve kanvas √ºzerine
                            yerle≈ütir.</p>
                    </div>
                </div>
            </div>
            <div class="card-shadcn-content space-y-4">
                <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
                    <div class="flex flex-wrap gap-2 lg:max-w-3xl">
                        {% for type in seating_types %}
                        <button class="btn-shadcn btn-shadcn-outline seating-type-btn"
                            style="background-color: {{ type.color_code }}; color: #fff; border-color: rgba(255,255,255,0.4);"
                            data-type-id="{{ type.id }}" data-type-name="{{ type.name }}"
                            data-seat-type="{{ type.seat_type }}" data-capacity="{{ type.capacity }}"
                            data-color="{{ type.color_code }}">
                            <i class="fas fa-{{ 'table' if type.seat_type == 'table' else 'chair' }}"></i>
                            {{ type.name }} ({{ type.capacity }})
                        </button>
                        {% endfor %}
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="btn-shadcn btn-shadcn-outline" id="delete-selected-btn" disabled>
                            <i class="fas fa-trash"></i>
                            <span>Se√ßileni Sil</span>
                        </button>
                        <button class="btn-shadcn btn-shadcn-destructive" id="clear-all-btn">
                            <i class="fas fa-broom"></i>
                            <span>T√ºm√ºn√º Temizle</span>
                        </button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <button class="btn-shadcn btn-shadcn-ghost" id="back-to-grid-btn">
                        <i class="fas fa-arrow-left"></i>
                        <span>√ñnceki Adƒ±m</span>
                    </button>
                    <button class="btn-shadcn btn-shadcn-default" id="save-layout-btn">
                        <i class="fas fa-save"></i>
                        <span>Yerle≈üimi Kaydet</span>
                    </button>
                </div>

                <div id="layout-info"
                    class="rounded-xl border border-dashed border-slate-200 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-800 dark:bg-slate-900/50 dark:text-slate-300">
                    <strong class="text-slate-800 dark:text-slate-100">ƒ∞pu√ßlarƒ±</strong>
                    <ul class="mt-2 list-disc space-y-1 pl-5">
                        <li>Bir koltuk t√ºr√º se√ß ve kanvas √ºzerinde tƒ±klayarak yerle≈ütir.</li>
                        <li>Koltuklarƒ± s√ºr√ºkleyerek hizalayabilir, grid a√ßƒ±kken otomatik hizalama kullanabilirsin.</li>
                        <li>Bir √∂ƒüeyi se√ßmek i√ßin √ºzerine tƒ±kla, silmek i√ßin ‚ÄúSe√ßileni Sil‚Äù butonunu kullan.</li>
                        <li>Yerle≈üimi kaydettiƒüinde etkinlik ana sayfasƒ±na y√∂nlendirileceksin.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card-shadcn">
        <div class="card-shadcn-header pb-4">
            <h2 class="text-lg font-semibold text-slate-900 dark:text-white">Kanvas √ñnizleme</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Sahne ve koltuk yerle≈üimlerini ger√ßek zamanlƒ± olarak
                d√ºzenle.</p>
        </div>
        <div class="card-shadcn-content">
            <div
                class="overflow-auto rounded-xl border border-dashed border-slate-200 bg-slate-100/60 p-4 dark:border-slate-800 dark:bg-slate-900/30">
                <div id="seating-canvas" class="grid-enabled"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global State
    let currentStep = 1;
    let stageElement = null;
    let selectedSeatingType = null;
    let selectedSeat = null;
    let seatCount = 1;
    let canvasWidth = 800;
    let canvasHeight = 600;
    let gridSize = 50;
    let snapToGrid = true;

    // Dragging state
    let isDragging = false;
    let isResizing = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let dragElement = null;

    const canvas = document.getElementById( 'seating-canvas' );

    // Initialize canvas
    function initCanvas( width, height ) {
        canvasWidth = width;
        canvasHeight = height;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
    }

    // Initial size
    initCanvas( 800, 600 );

    // Step Navigation
    function showStep( step ) {
        document.querySelectorAll( '.setup-wizard' ).forEach( el => el.classList.remove( 'active' ) );
        document.querySelectorAll( '.step' ).forEach( el => {
            el.classList.remove( 'active' );
            el.classList.remove( 'completed' );
        } );

        document.getElementById( `step-${step}` ).classList.add( 'active' );
        document.getElementById( `step-${step}-indicator` ).classList.add( 'active' );

        for ( let i = 1; i < step; i++ ) {
            document.getElementById( `step-${i}-indicator` ).classList.add( 'completed' );
        }

        currentStep = step;
    }

    // Snap to grid helper
    function snapToGridPosition( value ) {
        if ( !snapToGrid ) return value;
        return Math.round( value / gridSize ) * gridSize;
    }

    // ==================== STEP 1: Stage Placement ====================

    let isPlacingStage = false;

    document.getElementById( 'place-stage-btn' ).addEventListener( 'click', function () {
        const width = parseInt( document.getElementById( 'stage-width' ).value );
        const height = parseInt( document.getElementById( 'stage-height' ).value );

        if ( stageElement ) {
            stageElement.remove();
        }

        stageElement = document.createElement( 'div' );
        stageElement.className = 'stage placing';
        stageElement.style.width = width + 'px';
        stageElement.style.height = height + 'px';
        stageElement.innerHTML = '<i class="fas fa-theater-masks me-2"></i>SAHNE';
        stageElement.style.left = '50px';
        stageElement.style.top = '50px';

        canvas.appendChild( stageElement );
        isPlacingStage = true;

        alert( 'Sahneyi yerle≈ütirmek i√ßin tuval √ºzerinde bir yere tƒ±klayƒ±n' );
    } );

    document.getElementById( 'confirm-stage-btn' ).addEventListener( 'click', function () {
        if ( !stageElement ) {
            alert( '√ñnce sahneyi yerle≈ütirin!' );
            return;
        }
        stageElement.classList.remove( 'placing' );
        isPlacingStage = false;
        showStep( 2 );
    } );

    // ==================== STEP 2: Grid Configuration ====================

    document.getElementById( 'show-grid' ).addEventListener( 'change', function () {
        if ( this.checked ) {
            canvas.classList.add( 'grid-enabled' );
        } else {
            canvas.classList.remove( 'grid-enabled' );
        }
        snapToGrid = this.checked;
    } );

    document.getElementById( 'grid-size' ).addEventListener( 'change', function () {
        gridSize = parseInt( this.value );
        canvas.style.backgroundSize = `${gridSize}px ${gridSize}px`;
    } );

    document.getElementById( 'configure-grid-btn' ).addEventListener( 'click', function () {
        const totalTables = parseInt( document.getElementById( 'total-tables' ).value );
        gridSize = parseInt( document.getElementById( 'grid-size' ).value );

        // Calculate optimal canvas size based on table count
        // Assuming roughly sqrt(n) tables per row
        const tablesPerRow = Math.ceil( Math.sqrt( totalTables ) );
        const tableSize = 60; // Approximate table size
        const margin = 100; // Margin around canvas

        canvasWidth = Math.max( 800, ( tablesPerRow * tableSize ) + ( tablesPerRow * gridSize ) + margin );
        canvasHeight = Math.max( 600, canvasWidth * 0.75 );

        initCanvas( canvasWidth, canvasHeight );
        canvas.style.backgroundSize = `${gridSize}px ${gridSize}px`;

        document.getElementById( 'grid-info' ).classList.remove( 'hidden' );
        document.getElementById( 'canvas-dimensions' ).innerHTML = `
            <strong>Alan Boyutu:</strong> ${canvasWidth}px √ó ${canvasHeight}px<br>
            <strong>Izgara Boyutu:</strong> ${gridSize}px<br>
            <strong>Maksimum Masa:</strong> ${totalTables}
        `;

        document.getElementById( 'confirm-grid-btn' ).style.display = 'inline-block';
    } );

    document.getElementById( 'confirm-grid-btn' ).addEventListener( 'click', function () {
        showStep( 3 );
    } );

    document.getElementById( 'back-to-stage-btn' ).addEventListener( 'click', function () {
        showStep( 1 );
    } );

    // ==================== STEP 3: Seating Layout ====================

    document.querySelectorAll( '.seating-type-btn' ).forEach( btn => {
        btn.addEventListener( 'click', function () {
            document.querySelectorAll( '.seating-type-btn' ).forEach( b => {
                b.style.border = '2px solid rgba(0,0,0,0.2)';
            } );
            this.style.border = '3px solid #ffc107';

            selectedSeatingType = {
                id: this.dataset.typeId,
                name: this.dataset.typeName,
                seatType: this.dataset.seatType,
                capacity: this.dataset.capacity,
                color: this.dataset.color
            };
        } );
    } );

    document.getElementById( 'back-to-grid-btn' ).addEventListener( 'click', function () {
        showStep( 2 );
    } );

    document.getElementById( 'delete-selected-btn' ).addEventListener( 'click', function () {
        if ( selectedSeat ) {
            selectedSeat.remove();
            selectedSeat = null;
            this.disabled = true;
        }
    } );

    document.getElementById( 'clear-all-btn' ).addEventListener( 'click', function () {
        if ( confirm( 'T√ºm koltuklarƒ± silmek istediƒüinizden emin misiniz?' ) ) {
            document.querySelectorAll( '.seat' ).forEach( seat => seat.remove() );
            seatCount = 1;
            selectedSeat = null;
            document.getElementById( 'delete-selected-btn' ).disabled = true;
        }
    } );

    document.getElementById( 'save-layout-btn' ).addEventListener( 'click', function () {
        const seats = [];
        document.querySelectorAll( '.seat' ).forEach( seat => {
            seats.push( {
                seating_type_id: seat.dataset.typeId,
                seat_number: seat.textContent,
                position_x: parseInt( seat.style.left ),
                position_y: parseInt( seat.style.top ),
                width: parseInt( seat.style.width ) || 60,
                height: parseInt( seat.style.height ) || 40,
                color_code: seat.style.backgroundColor || seat.dataset.color
            } );
        } );

        const stageData = stageElement ? {
            width: parseInt( stageElement.style.width ),
            height: parseInt( stageElement.style.height ),
            position_x: parseInt( stageElement.style.left ),
            position_y: parseInt( stageElement.style.top )
        } : null;

        const layoutData = {
            seats: seats,
            stage: stageData,
            stage_position: 'top',
            canvas_width: canvasWidth,
            canvas_height: canvasHeight,
            grid_size: gridSize
        };

        console.log( 'üì§ G√∂nderilen veri:', layoutData );

        fetch( "{{ url_for('event.save_layout', event_id=event.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify( layoutData )
        } )
            .then( response => response.json() )
            .then( data => {
                console.log( 'üì• Sunucu yanƒ±tƒ±:', data );
                if ( data.success ) {
                    alert( 'Yerle≈üim planƒ± ba≈üarƒ±yla kaydedildi!' );
                    window.location.href = "{{ url_for('event.index') }}";
                } else {
                    alert( 'Hata: ' + ( data.message || 'Bilinmeyen hata' ) );
                }
            } )
            .catch( error => {
                console.error( '‚ùå Kayƒ±t hatasƒ±:', error );
                alert( 'Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu: ' + error.message );
            } );
    } );

    // ==================== Canvas Interactions ====================

    canvas.addEventListener( 'click', function ( e ) {
        const rect = this.getBoundingClientRect();
        let x = e.clientX - rect.left;
        let y = e.clientY - rect.top;

        // Step 1: Place stage
        if ( isPlacingStage && stageElement ) {
            x = snapToGridPosition( x - parseInt( stageElement.style.width ) / 2 );
            y = snapToGridPosition( y - parseInt( stageElement.style.height ) / 2 );

            stageElement.style.left = x + 'px';
            stageElement.style.top = y + 'px';

            document.getElementById( 'confirm-stage-btn' ).style.display = 'inline-block';
            isPlacingStage = false;
            stageElement.classList.remove( 'placing' );

            makeDraggable( stageElement );
            makeResizable( stageElement );
            return;
        }

        // Step 3: Place seats
        if ( currentStep === 3 && selectedSeatingType && !isDragging ) {
            createSeat( x, y );
        }
    } );

    function createSeat( x, y ) {
        const seat = document.createElement( 'div' );
        seat.className = 'seat ' + selectedSeatingType.seatType;

        const size = selectedSeatingType.seatType === 'table' ? 60 : 35;
        seat.style.width = size + 'px';
        seat.style.height = size + 'px';

        x = snapToGridPosition( x - size / 2 );
        y = snapToGridPosition( y - size / 2 );

        seat.style.left = x + 'px';
        seat.style.top = y + 'px';
        seat.style.backgroundColor = selectedSeatingType.color;
        seat.dataset.typeId = selectedSeatingType.id;
        seat.textContent = seatCount++;

        canvas.appendChild( seat );
        makeDraggable( seat );

        seat.addEventListener( 'click', function ( e ) {
            e.stopPropagation();
            if ( selectedSeat ) {
                selectedSeat.classList.remove( 'selected' );
            }
            this.classList.add( 'selected' );
            selectedSeat = this;
            document.getElementById( 'delete-selected-btn' ).disabled = false;
        } );
    }

    function makeDraggable( element ) {
        element.addEventListener( 'mousedown', function ( e ) {
            if ( e.target.classList.contains( 'resize-handle' ) ) return;

            isDragging = true;
            dragElement = this;
            const rect = this.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;

            this.style.cursor = 'grabbing';
        } );
    }

    function makeResizable( element ) {
        const handle = document.createElement( 'div' );
        handle.className = 'resize-handle se';
        element.appendChild( handle );

        handle.addEventListener( 'mousedown', function ( e ) {
            e.stopPropagation();
            isResizing = true;
            dragElement = element;
        } );
    }

    document.addEventListener( 'mousemove', function ( e ) {
        if ( isDragging && dragElement ) {
            const canvasRect = canvas.getBoundingClientRect();
            let x = e.clientX - canvasRect.left - dragOffsetX;
            let y = e.clientY - canvasRect.top - dragOffsetY;

            x = snapToGridPosition( x );
            y = snapToGridPosition( y );

            x = Math.max( 0, Math.min( x, canvasWidth - dragElement.offsetWidth ) );
            y = Math.max( 0, Math.min( y, canvasHeight - dragElement.offsetHeight ) );

            dragElement.style.left = x + 'px';
            dragElement.style.top = y + 'px';
        }

        if ( isResizing && dragElement ) {
            const canvasRect = canvas.getBoundingClientRect();
            let newWidth = snapToGridPosition( e.clientX - canvasRect.left - parseInt( dragElement.style.left ) );
            let newHeight = snapToGridPosition( e.clientY - canvasRect.top - parseInt( dragElement.style.top ) );

            newWidth = Math.max( 100, Math.min( newWidth, canvasWidth - parseInt( dragElement.style.left ) ) );
            newHeight = Math.max( 50, Math.min( newHeight, canvasHeight - parseInt( dragElement.style.top ) ) );

            dragElement.style.width = newWidth + 'px';
            dragElement.style.height = newHeight + 'px';
        }
    } );

    document.addEventListener( 'mouseup', function () {
        if ( dragElement ) {
            dragElement.style.cursor = 'move';
        }
        isDragging = false;
        isResizing = false;
        dragElement = null;
    } );
</script>
{% endblock %}