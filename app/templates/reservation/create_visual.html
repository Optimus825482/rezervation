{% extends "base.html" %}
{% block title %}Görsel Rezervasyon - {{ event.name }}{% endblock %}

{% block extra_css %}
<style>
    #reservation-canvas {
        position: relative;
        margin: 0 auto;
        cursor: pointer;
        border-radius: 1rem;
        border: 2px solid hsl(var(--border));
        background: hsl(var(--card));
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
    }

    #reservation-canvas.grid-enabled {
        background-image:
            repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(148, 163, 184, 0.1) 49px, rgba(148, 163, 184, 0.15) 50px),
            repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(148, 163, 184, 0.1) 49px, rgba(148, 163, 184, 0.15) 50px);
        background-size: 50px 50px;
    }

    .seat {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 600;
        font-size: 12px;
        user-select: none;
        border: 2px solid rgba(15, 23, 42, 0.15);
        box-shadow: 0 4px 8px rgba(15, 23, 42, 0.1);
        transition: all 0.2s ease;
        cursor: pointer;
        border-radius: 0.75rem;
    }

    .seat.available {
        background-color: #10b981;
        cursor: pointer;
    }

    .seat.available:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
        border-color: #059669;
    }

    .seat.reserved {
        background-color: #ef4444;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .seat.selected {
        background-color: #f59e0b;
        border: 3px solid #d97706;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
        transform: scale(1.1);
    }

    .stage {
        position: absolute;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.9) 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-weight: 700;
        border: 3px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
        font-size: 18px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        border-radius: 0.75rem;
        pointer-events: none;
    }

    .legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: hsl(var(--muted));
        border-radius: 0.75rem;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 0.375rem;
        border: 2px solid rgba(15, 23, 42, 0.15);
    }

    .seat-info-card {
        position: sticky;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="space-y-1">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-600">Görsel Rezervasyon</p>
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">{{ event.name|safe_text }}</h1>
            <p class="text-sm text-slate-600 dark:text-slate-400">
                {{ event.event_date.strftime('%d.%m.%Y') }} - {{ event.venue_name }}
            </p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <a href="{{ url_for('reservation.index') }}" class="btn-shadcn btn-shadcn-ghost btn-shadcn-sm">
                <i class="fas fa-arrow-left"></i>
                <span>Rezervasyonlar</span>
            </a>
        </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
        <div class="lg:col-span-2 space-y-4">
            <div class="card-shadcn">
                <div class="card-shadcn-header">
                    <h2 class="text-lg font-semibold">Oturum Planı</h2>
                    <p class="text-sm text-muted-foreground">Müsait bir oturum seçin</p>
                </div>
                <div class="card-shadcn-content">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-box" style="background-color: #10b981;"></div>
                            <span>Müsait</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background-color: #ef4444;"></div>
                            <span>Dolu</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background-color: #f59e0b;"></div>
                            <span>Seçili</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-shadcn">
                <div class="card-shadcn-content">
                    <div class="overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-900/30">
                        <div id="reservation-canvas" class="grid-enabled"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="card-shadcn seat-info-card">
                <div class="card-shadcn-header">
                    <h2 class="text-lg font-semibold">Rezervasyon Bilgileri</h2>
                </div>
                <div class="card-shadcn-content space-y-4">
                    <div id="no-selection" class="text-center py-8 text-muted-foreground">
                        <i class="fas fa-hand-pointer text-4xl mb-3 opacity-50"></i>
                        <p>Lütfen bir oturum seçin</p>
                    </div>

                    <form id="reservation-form" style="display: none;" class="space-y-4">
                        <div id="seat-details" class="p-4 bg-muted rounded-lg space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Oturum:</span>
                                <span id="selected-seat-number" class="font-bold"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Kapasite:</span>
                                <span id="selected-seat-capacity" class="font-bold"></span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Tip:</span>
                                <span id="selected-seat-type" class="font-bold"></span>
                            </div>
                        </div>

                        <input type="hidden" id="seating_id" name="seating_id">

                        <div class="space-y-2">
                            <label class="label-shadcn">Telefon *</label>
                            <input type="tel" id="phone" name="phone" class="input-shadcn" 
                                   placeholder="05XX XXX XX XX" required>
                        </div>

                        <div class="space-y-2">
                            <label class="label-shadcn">Ad *</label>
                            <input type="text" id="first_name" name="first_name" class="input-shadcn" 
                                   placeholder="Ad" required>
                        </div>

                        <div class="space-y-2">
                            <label class="label-shadcn">Soyad *</label>
                            <input type="text" id="last_name" name="last_name" class="input-shadcn" 
                                   placeholder="Soyad" required>
                        </div>

                        <div class="space-y-2">
                            <label class="label-shadcn">Kişi Sayısı *</label>
                            <input type="number" id="number_of_people" name="number_of_people" 
                                   class="input-shadcn" min="1" value="1" required>
                        </div>

                        <div class="space-y-2">
                            <label class="label-shadcn">Notlar</label>
                            <textarea id="notes" name="notes" class="input-shadcn" rows="3" 
                                      placeholder="Ek notlar..."></textarea>
                        </div>

                        <div class="flex gap-2">
                            <button type="submit" class="btn-shadcn btn-shadcn-default flex-1">
                                <i class="fas fa-check"></i>
                                <span>Rezervasyon Oluştur</span>
                            </button>
                            <button type="button" id="cancel-selection" class="btn-shadcn btn-shadcn-ghost">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card-shadcn">
                <div class="card-shadcn-header">
                    <h3 class="font-semibold">İstatistikler</h3>
                </div>
                <div class="card-shadcn-content space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-muted-foreground">Toplam Oturum:</span>
                        <span id="total-seats" class="font-bold">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-muted-foreground">Müsait:</span>
                        <span id="available-seats" class="font-bold text-green-600">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-muted-foreground">Dolu:</span>
                        <span id="reserved-seats" class="font-bold text-red-600">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-muted-foreground">Doluluk Oranı:</span>
                        <span id="occupancy-rate" class="font-bold">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/modal-helpers.js"></script>
<script>
    const canvas = document.getElementById('reservation-canvas');
    const eventId = {{ event.id }};
    let selectedSeat = null;
    let seatsData = [];

    // Canvas'ı yükle
    async function loadCanvas() {
        try {
            const response = await fetch(`/event/${eventId}/seating-config`);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message || 'Veri yüklenemedi');
            }

            const data = result.data;
            
            // Canvas boyutlarını ayarla
            canvas.style.width = data.canvas.width + 'px';
            canvas.style.height = data.canvas.height + 'px';

            // Sahneyi çiz
            if (data.stage && data.stage.config) {
                drawStage(data.stage.config);
            }

            // Oturumları çiz
            seatsData = data.seatings || [];
            drawSeats(seatsData);

            // İstatistikleri güncelle
            updateStatistics();

        } catch (error) {
            console.error('Canvas yükleme hatası:', error);
            showError('Yerleşim planı yüklenirken hata oluştu: ' + error.message);
        }
    }

    function drawStage(stageConfig) {
        const stage = document.createElement('div');
        stage.className = 'stage';
        stage.style.width = stageConfig.width + 'px';
        stage.style.height = stageConfig.height + 'px';
        stage.style.left = stageConfig.position_x + 'px';
        stage.style.top = stageConfig.position_y + 'px';
        stage.innerHTML = '<i class="fas fa-theater-masks"></i>SAHNE';
        canvas.appendChild(stage);
    }

    function drawSeats(seats) {
        seats.forEach(seatData => {
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.dataset.id = seatData.id;
            seat.dataset.capacity = seatData.capacity;
            seat.dataset.name = seatData.name;
            
            // Rezervasyon durumuna göre class ekle
            const isReserved = checkIfReserved(seatData.id);
            seat.classList.add(isReserved ? 'reserved' : 'available');

            seat.style.width = seatData.width + 'px';
            seat.style.height = seatData.height + 'px';
            seat.style.left = seatData.position_x + 'px';
            seat.style.top = seatData.position_y + 'px';
            
            if (!isReserved) {
                seat.style.backgroundColor = seatData.color_code;
            }

            seat.textContent = seatData.seat_number;

            // Sadece müsait oturumlara tıklama ekle
            if (!isReserved) {
                seat.addEventListener('click', () => selectSeat(seatData, seat));
            }

            canvas.appendChild(seat);
        });
    }

    function checkIfReserved(seatId) {
        // Backend'den gelen rezervasyon durumunu kontrol et
        const seatData = seatsData.find(s => s.id === seatId);
        return seatData && seatData.is_reserved;
    }

    function selectSeat(seatData, seatElement) {
        // Önceki seçimi temizle
        if (selectedSeat) {
            selectedSeat.element.classList.remove('selected');
        }

        // Yeni seçimi işaretle
        seatElement.classList.add('selected');
        selectedSeat = {
            data: seatData,
            element: seatElement
        };

        // Form alanlarını doldur
        document.getElementById('seating_id').value = seatData.id;
        document.getElementById('selected-seat-number').textContent = seatData.seat_number;
        document.getElementById('selected-seat-capacity').textContent = seatData.capacity + ' kişi';
        document.getElementById('selected-seat-type').textContent = seatData.name;
        document.getElementById('number_of_people').max = seatData.capacity;
        document.getElementById('number_of_people').value = Math.min(1, seatData.capacity);

        // Formu göster
        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('reservation-form').style.display = 'block';
    }

    function updateStatistics() {
        const total = seatsData.length;
        const reserved = seatsData.filter(s => s.is_reserved).length;
        const available = total - reserved;
        const occupancyRate = total > 0 ? Math.round((reserved / total) * 100) : 0;

        document.getElementById('total-seats').textContent = total;
        document.getElementById('available-seats').textContent = available;
        document.getElementById('reserved-seats').textContent = reserved;
        document.getElementById('occupancy-rate').textContent = occupancyRate + '%';
    }

    // Seçimi iptal et
    document.getElementById('cancel-selection').addEventListener('click', () => {
        if (selectedSeat) {
            selectedSeat.element.classList.remove('selected');
            selectedSeat = null;
        }
        document.getElementById('no-selection').style.display = 'block';
        document.getElementById('reservation-form').style.display = 'none';
        document.getElementById('reservation-form').reset();
    });

    // Form gönderimi
    document.getElementById('reservation-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!selectedSeat) {
            showWarning('Lütfen bir oturum seçin', 'Oturum Seçilmedi');
            return;
        }

        const formData = {
            seating_id: document.getElementById('seating_id').value,
            phone: document.getElementById('phone').value,
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value,
            number_of_people: document.getElementById('number_of_people').value,
            notes: document.getElementById('notes').value
        };

        try {
            const response = await fetch(`/reservation/create/${eventId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                await showSuccess('Rezervasyon başarıyla oluşturuldu!');
                window.location.href = '/reservation';
            } else {
                showError(result.message || 'Bilinmeyen hata');
            }
        } catch (error) {
            console.error('Rezervasyon hatası:', error);
            showError('Rezervasyon oluşturulurken hata oluştu');
        }
    });

    // Sayfa yüklendiğinde canvas'ı yükle
    loadCanvas();
</script>
{% endblock %}
