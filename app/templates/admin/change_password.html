{% extends "base.html" %}
{% block title %}Şifre Değiştir{% endblock %}
{% block content %}
<div class="mx-auto max-w-xl space-y-6">
    <div class="space-y-1 text-center">
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400 dark:text-slate-600">Hesap güvenliği</p>
        <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Şifre Değiştir</h1>
        <p class="text-sm text-slate-600 dark:text-slate-400">Yeni şifren güçlü ve benzersiz olmalı.</p>
    </div>

    <section class="card-shadcn">
        <div class="card-shadcn-content space-y-5">
            <form method="POST" class="space-y-5" data-password-form>
                <label class="space-y-2">
                    <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Mevcut
                        Şifre</span>
                    <div class="relative">
                        <input type="password" class="input-shadcn pr-12" name="current_password"
                            autocomplete="current-password" required data-password-field="current">
                        <button type="button"
                            class="absolute inset-y-0 right-0 flex items-center gap-2 pr-4 text-xs font-medium text-slate-500 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200"
                            data-toggle-password="current">
                            <i class="fas fa-eye"></i>
                            <span>Göster</span>
                        </button>
                    </div>
                </label>

                <label class="space-y-2">
                    <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Yeni
                        Şifre</span>
                    <div class="relative">
                        <input type="password" class="input-shadcn pr-12" name="new_password"
                            autocomplete="new-password" required data-password-field="new">
                        <button type="button"
                            class="absolute inset-y-0 right-0 flex items-center gap-2 pr-4 text-xs font-medium text-slate-500 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200"
                            data-toggle-password="new">
                            <i class="fas fa-eye"></i>
                            <span>Göster</span>
                        </button>
                    </div>
                    <span class="text-xs text-slate-500 dark:text-slate-400" data-password-feedback>Şifre kurallarını
                        aşağıdan takip et.</span>
                </label>

                <label class="space-y-2">
                    <span class="label-shadcn text-sm font-semibold text-slate-700 dark:text-slate-200">Yeni Şifre
                        (Tekrar)</span>
                    <div class="relative">
                        <input type="password" class="input-shadcn pr-12" name="confirm_password"
                            autocomplete="new-password" required data-password-field="confirm">
                        <button type="button"
                            class="absolute inset-y-0 right-0 flex items-center gap-2 pr-4 text-xs font-medium text-slate-500 transition hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200"
                            data-toggle-password="confirm">
                            <i class="fas fa-eye"></i>
                            <span>Göster</span>
                        </button>
                    </div>
                    <span class="text-xs text-slate-500 dark:text-slate-400" data-confirm-feedback>Şifre tekrarını
                        gir.</span>
                </label>

                <div class="flex flex-col gap-3 pt-2 sm:flex-row">
                    <button type="submit" class="btn-shadcn btn-shadcn-default flex-1">
                        <i class="fas fa-check"></i>
                        <span>Şifreyi Değiştir</span>
                    </button>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn-shadcn btn-shadcn-outline flex-1">
                        <i class="fas fa-arrow-left"></i>
                        <span>İptal</span>
                    </a>
                </div>
            </form>
        </div>
    </section>

    <section
        class="card-shadcn border border-dashed border-slate-200 bg-slate-50 dark:border-slate-800 dark:bg-slate-900/40">
        <div class="card-shadcn-content space-y-3">
            <div class="flex items-center gap-3">
                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-primary/10 text-primary">
                    <i class="fas fa-shield-alt"></i>
                </span>
                <div>
                    <h2 class="text-base font-semibold text-slate-900 dark:text-white">Şifre Güvenlik Gereksinimleri
                    </h2>
                    <p class="text-xs text-slate-500 dark:text-slate-400">Güvenli bir şifre oluştururken bu kurallara
                        uy.</p>
                </div>
            </div>
            <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300" data-password-rules>
                <li class="flex items-start gap-2" data-password-rule="length">
                    <i class="fas fa-circle text-[0.45rem] pt-2 text-primary"></i>
                    <span>En az 8 karakter uzunluğunda olmalı.</span>
                </li>
                <li class="flex items-start gap-2" data-password-rule="uppercase">
                    <i class="fas fa-circle text-[0.45rem] pt-2 text-primary"></i>
                    <span>En az 1 büyük harf (A-Z) içermeli.</span>
                </li>
                <li class="flex items-start gap-2" data-password-rule="lowercase">
                    <i class="fas fa-circle text-[0.45rem] pt-2 text-primary"></i>
                    <span>En az 1 küçük harf (a-z) içermeli.</span>
                </li>
                <li class="flex items-start gap-2" data-password-rule="digit">
                    <i class="fas fa-circle text-[0.45rem] pt-2 text-primary"></i>
                    <span>En az 1 rakam (0-9) içermeli.</span>
                </li>
                <li class="flex items-start gap-2" data-password-rule="special">
                    <i class="fas fa-circle text-[0.45rem] pt-2 text-primary"></i>
                    <span>En az 1 özel karakter (!@#$%^&amp;*()_+-=[]{}|;:,.&lt;&gt;?) içermeli.</span>
                </li>
            </ul>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script{% if g.csp_nonce %} nonce="{{ g.csp_nonce }}" {% endif %}>
    document.addEventListener( 'DOMContentLoaded', () => {
        const toggleButtons = document.querySelectorAll( '[data-toggle-password]' );
        const passwordFields = document.querySelectorAll( '[data-password-field]' );
        const newPasswordField = document.querySelector( '[data-password-field="new"]' );
        const confirmPasswordField = document.querySelector( '[data-password-field="confirm"]' );
        const feedback = document.querySelector( '[data-password-feedback]' );
        const confirmFeedback = document.querySelector( '[data-confirm-feedback]' );
        const rules = document.querySelectorAll( '[data-password-rule]' );

        const toggleVisibility = ( target ) => {
            const input = document.querySelector( `[data-password-field="${target}"]` );
            const button = document.querySelector( `[data-toggle-password="${target}"]` );
            if ( !input || !button ) return;

            const icon = button.querySelector( 'i' );
            const label = button.querySelector( 'span' );

            const isHidden = input.getAttribute( 'type' ) === 'password';
            input.setAttribute( 'type', isHidden ? 'text' : 'password' );
            if ( icon ) {
                icon.classList.remove( isHidden ? 'fa-eye' : 'fa-eye-slash' );
                icon.classList.add( isHidden ? 'fa-eye-slash' : 'fa-eye' );
            }
            if ( label ) {
                label.textContent = isHidden ? 'Gizle' : 'Göster';
            }
        };

        toggleButtons.forEach( ( button ) => {
            button.addEventListener( 'click', () => {
                toggleVisibility( button.dataset.togglePassword );
            } );
        } );

        const validationMap = {
            length: ( value ) => value.length >= 8,
            uppercase: ( value ) => /[A-ZÇĞİÖŞÜ]/.test( value ),
            lowercase: ( value ) => /[a-zçğıöşü]/.test( value ),
            digit: ( value ) => /\d/.test( value ),
            special: ( value ) => /[!@#$%^&*()_+\-=[\]{}|;:',.<>/?]/.test( value )
        };

        const updateRuleStates = ( value ) => {
            rules.forEach( ( rule ) => {
                const ruleKey = rule.dataset.passwordRule;
                const isValid = validationMap[ruleKey] ? validationMap[ruleKey]( value ) : false;
                rule.classList.toggle( 'text-emerald-500', isValid );
                rule.classList.toggle( 'text-slate-500', !isValid );
            } );
        };

        const updateFeedback = () => {
            if ( !feedback || !newPasswordField ) return;
            const value = newPasswordField.value.trim();
            const totalRules = Object.keys( validationMap ).length;
            const passed = Object.values( validationMap ).filter( ( check ) => check( value ) ).length;

            if ( !value ) {
                feedback.textContent = 'Şifre kurallarını aşağıdan takip et.';
                feedback.classList.remove( 'text-emerald-500', 'text-amber-500' );
                feedback.classList.add( 'text-slate-500' );
                return;
            }

            if ( passed === totalRules ) {
                feedback.textContent = 'Harika! Şifre tüm güvenlik kontrollerini geçti.';
                feedback.classList.add( 'text-emerald-500' );
                feedback.classList.remove( 'text-slate-500', 'text-amber-500' );
            } else {
                feedback.textContent = `${passed}/${totalRules} kuralı karşıladın.`;
                feedback.classList.add( 'text-amber-500' );
                feedback.classList.remove( 'text-slate-500', 'text-emerald-500' );
            }
        };

        const updateConfirmFeedback = () => {
            if ( !confirmFeedback || !confirmPasswordField || !newPasswordField ) return;
            const confirmValue = confirmPasswordField.value.trim();
            const newValue = newPasswordField.value.trim();

            if ( !confirmValue ) {
                confirmFeedback.textContent = 'Şifre tekrarını gir.';
                confirmFeedback.classList.remove( 'text-emerald-500', 'text-rose-500' );
                confirmFeedback.classList.add( 'text-slate-500' );
                return;
            }

            const isMatch = confirmValue === newValue && confirmValue.length > 0;
            confirmFeedback.textContent = isMatch ? 'Şifreler eşleşiyor.' : 'Şifreler eşleşmiyor.';
            confirmFeedback.classList.toggle( 'text-emerald-500', isMatch );
            confirmFeedback.classList.toggle( 'text-rose-500', !isMatch );
            confirmFeedback.classList.remove( 'text-slate-500' );
        };

        if ( newPasswordField ) {
            newPasswordField.addEventListener( 'input', () => {
                const value = newPasswordField.value;
                updateRuleStates( value );
                updateFeedback();
                updateConfirmFeedback();
            } );
        }

        if ( confirmPasswordField ) {
            confirmPasswordField.addEventListener( 'input', () => {
                updateConfirmFeedback();
            } );
        }

        passwordFields.forEach( ( field ) => {
            field.addEventListener( 'blur', () => {
                field.value = field.value.trim();
            } );
        } );
    } );
</script>
        {% endblock %}